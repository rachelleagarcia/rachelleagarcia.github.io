I"<p>Legacy is also one of the first machines released on Hack The Box (HTB) and aimed for beginners. It is a Windows box that is vulnerable to SMB bugs and I’ll be using Metasploit to exploit them.</p>

<h2 id="hack-the-box">Hack The Box</h2>

<ul>
  <li>Operating System: Windows</li>
  <li>Difficulty: Easy</li>
</ul>

<h2 id="enumeration">Enumeration</h2>

<p>Let’s start with enumeration by using nmap. As always, I like to use:</p>

<p><img src="/images/blog/legacy/ipaddress.jpg" alt="nmap scan" /></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
</pre></td><td class="rouge-code"><pre>PORT     STATE  SERVICE       VERSION
139/tcp  open   netbios-ssn   Microsoft Windows netbios-ssn
445/tcp  open   microsoft-ds  Windows XP microsoft-ds
3389/tcp closed ms-wbt-server
Device type: general purpose|specialized
Running (JUST GUESSING): Microsoft Windows XP|2003|2000|2008 (94%), General Dynamics embedded (87%)
OS CPE: cpe:/o:microsoft:windows_xp::sp3 cpe:/o:microsoft:windows_server_2003::sp1 cpe:/o:microsoft:windows_server_2003::sp2 cpe:/o:microsoft:windows_2000::sp4 cpe:/o:microsoft:windows_server_2008::sp2
Aggressive OS guesses: Microsoft Windows XP SP3 (94%), Microsoft Windows Server 2003 SP1 or SP2 (92%), Microsoft Windows XP (92%), Microsoft Windows Server 2003 SP2 (91%), Microsoft Windows XP SP2 or Windows Server 2003 (90%), Microsoft Windows 2000 SP4 (90%), Microsoft Windows XP SP2 or SP3 (90%), Microsoft Windows 2000 SP4 or Windows XP SP2 or SP3 (90%), Microsoft Windows 2003 SP2 (89%), Microsoft Windows XP SP2 (89%)
No exact OS matches for host (test conditions non-ideal).
Network Distance: 2 hops
Service Info: OSs: Windows, Windows XP; CPE: cpe:/o:microsoft:windows, cpe:/o:microsoft:windows_xp

Host script results:
|_clock-skew: mean: 5d00h30m01s, deviation: 2h07m16s, median: 4d23h00m01s
|_nbstat: NetBIOS name: LEGACY, NetBIOS user: &lt;unknown&gt;, NetBIOS MAC: 00:50:56:b9:34:e8 (VMware)
| smb-os-discovery: 
|   OS: Windows XP (Windows 2000 LAN Manager)
|   OS CPE: cpe:/o:microsoft:windows_xp::-
|   Computer name: legacy
|   NetBIOS computer name: LEGACY\x00
|   Workgroup: HTB\x00
|_  System time: 2020-05-24T02:40:58+03:00
| smb-security-mode: 
|   account_used: &lt;blank&gt;
|   authentication_level: user
|   challenge_response: supported
|_  message_signing: disabled (dangerous, but default)
|_smb2-time: Protocol negotiation failed (SMB2)
</pre></td></tr></tbody></table></code></pre></div></div>

<p>It looks like we have port 139 and 445 open, and based on the nmap scan, we might have also found the SMB OS, <em>Windows XP</em>. Before we exploit this box, let’s verify that the OS is the right one by using one of Metasploit’s auxiliary modules.</p>

<h3 id="smb-information">SMB Information</h3>

<p>To open up Meatsploit whilst in the command line interface, type in:</p>

<p><code class="language-plaintext highlighter-rouge">msfconsole</code></p>

<p>Once Metasploit opens, we can use Metasploit’s auxiliary module, smb_version. There are a lot of auxiliary modules, so if you’re not sure which one to use, we can search for it by typing in Metasploit:</p>

<p><code class="language-plaintext highlighter-rouge">search smb_version</code></p>

<p><img src="/images/blog/legacy/smbversion.jpg" alt="smb version" /></p>

<p>From the search results, we can see that there is an auxiliary module called smb_version. To use it, we can type in Metasploit:</p>

<p><code class="language-plaintext highlighter-rouge">use auxiliary/scanner/smb/smb_version</code></p>

<p>As always, I like to see what options I have when I use a Metasploit module by typing in <code class="language-plaintext highlighter-rouge">options</code>. After taking a look at the options, I set the following:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">rhosts</code>: The IP address of the Legacy box.</li>
  <li><code class="language-plaintext highlighter-rouge">target</code>: To see if there are any targets to set–in this case, there is none.</li>
  <li><code class="language-plaintext highlighter-rouge">run</code>: To run the auxiliary module.</li>
</ul>

<p><img src="/images/blog/legacy/auxiliary.jpg" alt="auxiliary scan" /></p>

<p>Perfect! Based on the results above, the box is currently running <em>Windows XP SP3</em>. Now that we have confirmed the OS that the SMB is on, let’s look for any existing exploits.</p>

<p>In the last box (Lame), we used Metasploit’s search feature to find an exploit. This time to make it interesting, we can use Google search. I normally like to look for results from Rapid7 (which is the same as Metasploit) or Exploit-db.</p>

<p>After searching <i>Windows XP SP3 exploit</i> in Google search, I came across this one from Rapid 7:</p>

<p><a href="https://www.rapid7.com/db/modules/exploit/windows/smb/ms08_067_netapi">MS08-067 Microsoft Server Service Relative Path Stack Corruption</a></p>

<p>Here’s what it says on the exploit’s description:</p>

<p><i>This module exploits a parsing flaw in the path canonicalization code of NetAPI32.dll through the Server Service. This module is capable of bypassing NX on some operating systems/service packs.</i></p>

<p>This exploit looks promising, so let’s try using it.</p>

<h2 id="exploitation">Exploitation</h2>

<p>To use the exploit that we found, we can follow the instructions found in the above link and type in:</p>

<p><code class="language-plaintext highlighter-rouge">use exploit/windows/smb/ms08_067_netapi</code></p>

<p>Again, let’s take a look at our options by typing in <code class="language-plaintext highlighter-rouge">options</code>.</p>

<p><img src="/images/blog/legacy/exploit.jpg" alt="preparing exploit" /></p>

<p>In this case, I set the rhost to the IP address of the box, 10.10.10.4, by typing in:</p>

<p><code class="language-plaintext highlighter-rouge">set rhosts 10.10.10.4</code></p>

<p>And that’s it, let’s try running the exploit!</p>

<p><img src="/images/blog/legacy/runexploit.jpg" alt="exploit results" /></p>

<p>It worked! We now have a Meterpreter session. Meaning, we have access to the box. We can type in:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">getuid</code>: To see what access level we have.</li>
  <li><code class="language-plaintext highlighter-rouge">pwd</code>: To check which directory we’re currently in.</li>
</ul>

<p>Since we have root access, we can type in <code class="language-plaintext highlighter-rouge">shell</code> to that we have access to the command line and locate the root.txt and user.txt file.</p>

<p>And that’s it! We’ve now completed the Legacy box.</p>

<h2 id="conclusion">Conclusion</h2>

<p>This goes to show that once you find a port open, in this case, SMB, always enumerate to find out what OS version the service is running. Once you know the version, it’ll be easier to find out what the system is vulnerable to and where to look when it comes to finding exploits.</p>
:ET